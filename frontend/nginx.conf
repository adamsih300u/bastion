server {
    listen 80;
    server_name _;
    
    # Docker internal DNS resolver for runtime hostname resolution
    resolver 127.0.0.11 valid=10s ipv6=off;
    resolver_timeout 5s;
    
    # Allow very large file uploads (1.5GB limit for bulk operations)
    client_max_body_size 1500M;
    client_body_timeout 1800s;   # 30 minutes for very large uploads
    client_header_timeout 300s;
    
    # Serve static files
    root /usr/share/nginx/html;
    index index.html index.htm;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # **ROOSEVELT FIX:** WebDAV MUST come before static assets!
    # WebDAV Proxy for OrgMode Mobile Sync
    # Use ^~ to prevent regex locations from matching
    location ^~ /dav/ {
        # Use variable to force runtime DNS resolution (Docker-friendly!)
        set $webdav_upstream http://webdav:8001;
        
        # **ROOSEVELT'S CLEAN FIX:** Strip /dav prefix before forwarding to WsgiDAV
        # WsgiDAV provider mounted at "/" generates clean hrefs without /dav
        # Clients add their base URL (/dav) back when requesting
        # /dav/OrgMode/file.org â†’ /OrgMode/file.org
        rewrite ^/dav(.*)$ $1 break;
        proxy_pass $webdav_upstream;
        
        # WebDAV requires these headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Preserve authentication headers for WebDAV Basic Auth
        proxy_pass_header Authorization;
        proxy_set_header Authorization $http_authorization;
        
        # WebDAV-specific settings
        proxy_set_header Destination $http_destination;
        proxy_set_header Depth $http_depth;
        
        # Allow WebDAV methods
        proxy_method $request_method;
        
        # Timeouts for file operations
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
        
        # Large file support
        proxy_request_buffering off;
        proxy_buffering off;
        
        # Disable caching for WebDAV
        proxy_cache_bypass 1;
        proxy_no_cache 1;
        
        # Client body size for uploads
        client_max_body_size 500M;
    }

    # Cache static assets (but NOT /dav/ paths!)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Proxy generated images served by backend FastAPI
    location ^~ /static/images/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Proxy API requests to backend with retry logic
    location /api/ {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Retry logic for backend startup
        proxy_next_upstream error timeout http_502 http_503 http_504;
        
        # Preserve authentication headers
        proxy_pass_header Authorization;
        proxy_set_header Authorization $http_authorization;
        
        # CORS support for proxied requests
        proxy_hide_header Access-Control-Allow-Origin;
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since" always;
        
        # Handle preflight requests
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Credentials true always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Mx-ReqToken, Keep-Alive, X-Requested-With, If-Modified-Since" always;
            add_header Access-Control-Max-Age 86400;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
        
        proxy_connect_timeout 3600;  # 60 minutes for large ZIP file processing
        proxy_send_timeout 3600;     # 60 minutes for large file uploads
        proxy_read_timeout 3600;     # 60 minutes for processing responses
        proxy_buffering off;
        
        # Allow large request bodies for file uploads
        proxy_request_buffering off;
        
        # Optimize for very large file uploads
        proxy_max_temp_file_size 0;  # Disable temp file size limit
        proxy_temp_file_write_size 64k;
        
        # Handle WebSocket upgrades
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Proxy health check
    location /health {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Debug endpoint to check headers
    location /debug {
        add_header Content-Type application/json;
        return 200 '{"host":"$host","origin":"$http_origin","auth":"$http_authorization","forwarded_proto":"$scheme"}';
    }

    # Handle client-side routing
    location / {
        try_files $uri $uri/ /index.html;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }

    # Handle favicon requests
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }
} 