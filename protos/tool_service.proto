syntax = "proto3";

package tool_service;

// Tool Service - Backend exposes data access to orchestrator
service ToolService {
  // Document operations
  rpc SearchDocuments(SearchRequest) returns (SearchResponse);
  rpc FindDocumentsByTags(FindDocumentsByTagsRequest) returns (FindDocumentsByTagsResponse);
  rpc GetDocument(DocumentRequest) returns (DocumentResponse);
  rpc GetDocumentContent(DocumentRequest) returns (DocumentContentResponse);
  rpc FindDocumentByPath(FindDocumentByPathRequest) returns (FindDocumentByPathResponse);
  
  // RSS operations
  rpc SearchRSSFeeds(RSSSearchRequest) returns (RSSSearchResponse);
  rpc GetRSSArticles(RSSArticlesRequest) returns (RSSArticlesResponse);
  
  // RSS management operations
  rpc AddRSSFeed(AddRSSFeedRequest) returns (AddRSSFeedResponse);
  rpc ListRSSFeeds(ListRSSFeedsRequest) returns (ListRSSFeedsResponse);
  rpc RefreshRSSFeed(RefreshRSSFeedRequest) returns (RefreshRSSFeedResponse);
  rpc DeleteRSSFeed(DeleteRSSFeedRequest) returns (DeleteRSSFeedResponse);
  
  // Entity operations
  rpc SearchEntities(EntitySearchRequest) returns (EntitySearchResponse);
  rpc GetEntity(EntityRequest) returns (EntityResponse);
  
  // Weather operations
  rpc GetWeatherData(WeatherRequest) returns (WeatherResponse);
  
  // Image generation operations
  rpc GenerateImage(ImageGenerationRequest) returns (ImageGenerationResponse);
  
  // Org-mode operations
  rpc SearchOrgFiles(OrgSearchRequest) returns (OrgSearchResponse);
  rpc GetOrgInboxItems(OrgInboxRequest) returns (OrgInboxResponse);
  
  // Org Inbox management operations
  rpc ListOrgInboxItems(ListOrgInboxItemsRequest) returns (ListOrgInboxItemsResponse);
  rpc AddOrgInboxItem(AddOrgInboxItemRequest) returns (AddOrgInboxItemResponse);
  rpc ToggleOrgInboxItem(ToggleOrgInboxItemRequest) returns (ToggleOrgInboxItemResponse);
  rpc UpdateOrgInboxItem(UpdateOrgInboxItemRequest) returns (UpdateOrgInboxItemResponse);
  rpc SetOrgInboxSchedule(SetOrgInboxScheduleRequest) returns (SetOrgInboxScheduleResponse);
  rpc ApplyOrgInboxTags(ApplyOrgInboxTagsRequest) returns (ApplyOrgInboxTagsResponse);
  rpc ArchiveOrgInboxDone(ArchiveOrgInboxDoneRequest) returns (ArchiveOrgInboxDoneResponse);
  rpc AppendOrgInboxText(AppendOrgInboxTextRequest) returns (AppendOrgInboxTextResponse);
  rpc GetOrgInboxPath(GetOrgInboxPathRequest) returns (GetOrgInboxPathResponse);
  
  // Web search operations
  rpc SearchWeb(WebSearchRequest) returns (WebSearchResponse);
  rpc CrawlWebContent(WebCrawlRequest) returns (WebCrawlResponse);
  rpc SearchAndCrawl(SearchAndCrawlRequest) returns (SearchAndCrawlResponse);
  rpc CrawlWebsiteRecursive(RecursiveWebsiteCrawlRequest) returns (RecursiveWebsiteCrawlResponse);
  rpc CrawlSite(DomainCrawlRequest) returns (DomainCrawlResponse);
  
  // Enhancement operations
  rpc ExpandQuery(QueryExpansionRequest) returns (QueryExpansionResponse);
  rpc SearchConversationCache(CacheSearchRequest) returns (CacheSearchResponse);
  
  // File creation operations (user documents only)
  rpc CreateUserFile(CreateUserFileRequest) returns (CreateUserFileResponse);
  rpc CreateUserFolder(CreateUserFolderRequest) returns (CreateUserFolderResponse);
  
  // Document editing operations (user documents only)
  rpc UpdateDocumentMetadata(UpdateDocumentMetadataRequest) returns (UpdateDocumentMetadataResponse);
  rpc UpdateDocumentContent(UpdateDocumentContentRequest) returns (UpdateDocumentContentResponse);
  
  // Document edit proposal operations (universal edit proposal system)
  rpc ProposeDocumentEdit(ProposeDocumentEditRequest) returns (ProposeDocumentEditResponse);
  rpc ApplyDocumentEditProposal(ApplyDocumentEditProposalRequest) returns (ApplyDocumentEditProposalResponse);
  rpc ApplyOperationsDirectly(ApplyOperationsDirectlyRequest) returns (ApplyOperationsDirectlyResponse);
}

// Document Messages
message SearchRequest {
  string user_id = 1;
  string query = 2;
  int32 limit = 3;
  repeated string filters = 4;
}

message SearchResponse {
  repeated DocumentResult results = 1;
  int32 total_count = 2;
}

message FindDocumentsByTagsRequest {
  string user_id = 1;
  repeated string required_tags = 2;
  string collection_type = 3;  // "user", "global", or empty for both
  int32 limit = 4;
}

message FindDocumentsByTagsResponse {
  repeated DocumentResult results = 1;
  int32 total_count = 2;
}

message DocumentResult {
  string document_id = 1;
  string title = 2;
  string filename = 3;
  string content_preview = 4;
  float relevance_score = 5;
  map<string, string> metadata = 6;
}

message DocumentRequest {
  string document_id = 1;
  string user_id = 2;
}

message DocumentResponse {
  string document_id = 1;
  string title = 2;
  string filename = 3;
  string content_type = 4;
  map<string, string> metadata = 5;
}

message DocumentContentResponse {
  string document_id = 1;
  string content = 2;
  string format = 3;  // "text", "markdown", "html"
}

message FindDocumentByPathRequest {
  string user_id = 1;
  string file_path = 2;  // Relative or absolute filesystem path
  string base_path = 3;  // Base directory for resolving relative paths (optional)
}

message FindDocumentByPathResponse {
  bool success = 1;
  string document_id = 2;
  string filename = 3;
  string resolved_path = 4;  // Actual filesystem path found
  optional string error = 5;
}

// RSS Messages
message RSSSearchRequest {
  string user_id = 1;
  string query = 2;
  int32 limit = 3;
}

message RSSSearchResponse {
  repeated RSSFeed feeds = 1;
  repeated RSSArticle articles = 2;
}

message RSSFeed {
  string feed_id = 1;
  string feed_name = 2;
  string feed_url = 3;
  string description = 4;
}

message RSSArticle {
  string article_id = 1;
  string title = 2;
  string content = 3;
  string url = 4;
  string published_at = 5;
}

message RSSArticlesRequest {
  string feed_id = 1;
  string user_id = 2;
  int32 limit = 3;
}

message RSSArticlesResponse {
  repeated RSSArticle articles = 1;
}

// RSS Management Messages
message AddRSSFeedRequest {
  string user_id = 1;
  string feed_url = 2;
  string feed_name = 3;
  string category = 4;
  bool is_global = 5;  // If true, creates a global feed (admin only)
}

message AddRSSFeedResponse {
  bool success = 1;
  string feed_id = 2;
  string feed_name = 3;
  string message = 4;
  optional string error = 5;
}

message ListRSSFeedsRequest {
  string user_id = 1;
  string scope = 2;  // "user" or "global"
}

message ListRSSFeedsResponse {
  repeated RSSFeedDetails feeds = 1;
  int32 count = 2;
  bool success = 3;
  optional string error = 4;
}

message RSSFeedDetails {
  string feed_id = 1;
  string feed_name = 2;
  string feed_url = 3;
  string category = 4;
  bool is_global = 5;
  string last_polled = 6;
  int32 article_count = 7;
}

message RefreshRSSFeedRequest {
  string user_id = 1;
  string feed_name = 2;  // Feed name for user-friendly identification
  string feed_id = 3;     // Optional: direct feed ID
}

message RefreshRSSFeedResponse {
  bool success = 1;
  string feed_id = 2;
  string feed_name = 3;
  string task_id = 4;  // Celery task ID
  string message = 5;
  optional string error = 6;
}

message DeleteRSSFeedRequest {
  string user_id = 1;
  string feed_name = 2;  // Feed name for user-friendly identification
  string feed_id = 3;     // Optional: direct feed ID
}

message DeleteRSSFeedResponse {
  bool success = 1;
  string feed_id = 2;
  string message = 3;
  optional string error = 4;
}

// Entity Messages
message EntitySearchRequest {
  string user_id = 1;
  string query = 2;
  repeated string entity_types = 3;
  int32 limit = 4;
}

message EntitySearchResponse {
  repeated Entity entities = 1;
}

message Entity {
  string entity_id = 1;
  string entity_type = 2;
  string name = 3;
  map<string, string> properties = 4;
}

message EntityRequest {
  string entity_id = 1;
  string user_id = 2;
}

message EntityResponse {
  Entity entity = 1;
  repeated string related_documents = 2;
}

// Weather Messages
message WeatherRequest {
  string location = 1;
  string user_id = 2;
  repeated string data_types = 3;  // "current", "forecast", "alerts"
}

message WeatherResponse {
  string location = 1;
  string current_conditions = 2;
  repeated string forecast = 3;
  repeated string alerts = 4;
  map<string, string> metadata = 5;
}

// Org-mode Messages
message OrgSearchRequest {
  string user_id = 1;
  string query = 2;
  repeated string search_types = 3;  // "todos", "headings", "content"
  int32 limit = 4;
}

message OrgSearchResponse {
  repeated OrgSearchResult results = 1;
}

message OrgSearchResult {
  string document_id = 1;
  string document_name = 2;
  string heading = 3;
  string content = 4;
  int32 line_number = 5;
  map<string, string> metadata = 6;
}

message OrgInboxRequest {
  string user_id = 1;
  int32 limit = 2;
}

message OrgInboxResponse {
  repeated OrgInboxItem items = 1;
}

message OrgInboxItem {
  string item_id = 1;
  string title = 2;
  string content = 3;
  string timestamp = 4;
  map<string, string> metadata = 5;
}

// Org Inbox Management Messages
message ListOrgInboxItemsRequest {
  string user_id = 1;
}

message ListOrgInboxItemsResponse {
  bool success = 1;
  string path = 2;
  repeated OrgInboxItemDetails items = 3;
  optional string error = 4;
}

message OrgInboxItemDetails {
  int32 line_index = 1;
  string text = 2;
  string item_type = 3;  // "headline", "checkbox", "plain"
  string todo_state = 4;  // "TODO", "DONE", etc.
  repeated string tags = 5;
  bool is_done = 6;
}

message AddOrgInboxItemRequest {
  string user_id = 1;
  string text = 2;
  string kind = 3;  // "todo", "event", "contact", "checkbox"
  optional string schedule = 4;  // org timestamp
  optional string repeater = 5;  // +1w, .+1m, etc.
  repeated string tags = 6;
  map<string, string> contact_properties = 7;
}

message AddOrgInboxItemResponse {
  bool success = 1;
  int32 line_index = 2;
  string message = 3;
  optional string error = 4;
}

message ToggleOrgInboxItemRequest {
  string user_id = 1;
  int32 line_index = 2;
}

message ToggleOrgInboxItemResponse {
  bool success = 1;
  int32 updated_index = 2;
  string new_line = 3;
  optional string error = 4;
}

message UpdateOrgInboxItemRequest {
  string user_id = 1;
  int32 line_index = 2;
  string new_text = 3;
}

message UpdateOrgInboxItemResponse {
  bool success = 1;
  int32 updated_index = 2;
  string new_line = 3;
  optional string error = 4;
}

message SetOrgInboxScheduleRequest {
  string user_id = 1;
  int32 line_index = 2;
  string scheduled = 3;  // org timestamp <YYYY-MM-DD Dow>
  optional string repeater = 4;  // +1w, .+1m
}

message SetOrgInboxScheduleResponse {
  bool success = 1;
  int32 updated_index = 2;
  string scheduled_line = 3;
  optional string error = 4;
}

message ApplyOrgInboxTagsRequest {
  string user_id = 1;
  int32 line_index = 2;
  repeated string tags = 3;
}

message ApplyOrgInboxTagsResponse {
  bool success = 1;
  repeated string applied_tags = 2;
  optional string error = 3;
}

message ArchiveOrgInboxDoneRequest {
  string user_id = 1;
}

message ArchiveOrgInboxDoneResponse {
  bool success = 1;
  int32 archived_count = 2;
  string message = 3;
  optional string error = 4;
}

message AppendOrgInboxTextRequest {
  string user_id = 1;
  string text = 2;
}

message AppendOrgInboxTextResponse {
  bool success = 1;
  string message = 2;
  optional string error = 3;
}

message GetOrgInboxPathRequest {
  string user_id = 1;
}

message GetOrgInboxPathResponse {
  bool success = 1;
  string path = 2;
  optional string error = 3;
}

// Web Search Messages
message WebSearchRequest {
  string query = 1;
  int32 max_results = 2;
  string user_id = 3;
}

message WebSearchResponse {
  repeated WebSearchResult results = 1;
}

message WebSearchResult {
  string title = 1;
  string url = 2;
  string snippet = 3;
  float relevance_score = 4;
}

message WebCrawlRequest {
  string url = 1;
  string user_id = 2;
}

message WebCrawlResponse {
  string url = 1;
  string title = 2;
  string content = 3;
  string html = 4;
  map<string, string> metadata = 5;
}

message SearchAndCrawlRequest {
  string query = 1;
  int32 num_results = 2;
  string user_id = 3;
}

message SearchAndCrawlResponse {
  repeated WebSearchResult search_results = 1;
  repeated WebCrawlResult crawl_results = 2;
}

message WebCrawlResult {
  string url = 1;
  string title = 2;
  string content = 3;
  map<string, string> metadata = 4;
}

// Recursive Website Crawling Messages
message RecursiveWebsiteCrawlRequest {
  string start_url = 1;
  int32 max_pages = 2;
  int32 max_depth = 3;
  string user_id = 4;
}

message RecursiveWebsiteCrawlResponse {
  bool success = 1;
  string start_url = 2;
  string base_domain = 3;
  string crawl_session_id = 4;
  int32 total_items_crawled = 5;
  int32 html_pages_crawled = 6;
  int32 images_downloaded = 7;
  int32 documents_downloaded = 8;
  int32 total_items_failed = 9;
  int32 max_depth_reached = 10;
  float elapsed_time_seconds = 11;
  repeated CrawledPage crawled_pages = 12;
  optional string error = 13;
}

message CrawledPage {
  string url = 1;
  string content_type = 2;  // html, image, document
  string markdown_content = 3;
  string html_content = 4;
  map<string, string> metadata = 5;
  repeated string internal_links = 6;
  repeated string image_links = 7;
  repeated string document_links = 8;
  int32 depth = 9;
  optional string parent_url = 10;
  string crawl_time = 11;
  optional bytes binary_content = 12;  // For images/documents
  optional string filename = 13;
  optional string mime_type = 14;
  optional int32 size_bytes = 15;
}

// Domain-scoped crawl messages
message DomainCrawlRequest {
  string seed_url = 1;
  string query_criteria = 2;
  int32 max_pages = 3;
  int32 max_depth = 4;
  optional string allowed_path_prefix = 5;
  bool include_pdfs = 6;
  string user_id = 7;
}

message DomainCrawlResponse {
  bool success = 1;
  string domain = 2;
  int32 successful_crawls = 3;
  int32 urls_considered = 4;
  repeated DomainCrawlResult results = 5;
  optional string error = 6;
}

message DomainCrawlResult {
  string url = 1;
  string title = 2;
  string full_content = 3;
  map<string, string> metadata = 4;
  float relevance_score = 5;
  bool success = 6;
}

// Query Expansion Messages
message QueryExpansionRequest {
  string query = 1;
  int32 num_variations = 2;
  string user_id = 3;
}

message QueryExpansionResponse {
  string original_query = 1;
  repeated string expanded_queries = 2;
  repeated string key_entities = 3;
  int32 expansion_count = 4;
}

// Conversation Cache Messages
message CacheSearchRequest {
  string query = 1;
  string conversation_id = 2;
  int32 freshness_hours = 3;
  string user_id = 4;
}

message CacheSearchResponse {
  repeated CacheEntry entries = 1;
  bool cache_hit = 2;
}

message CacheEntry {
  string content = 1;
  string timestamp = 2;
  string agent_name = 3;
  float relevance_score = 4;
}

// Image Generation Messages
message ImageGenerationRequest {
  string prompt = 1;
  string size = 2;  // e.g., "1024x1024"
  string format = 3;  // e.g., "png", "jpg"
  optional int32 seed = 4;
  int32 num_images = 5;
  optional string negative_prompt = 6;
  string user_id = 7;
}

message ImageGenerationResponse {
  bool success = 1;
  string model = 2;
  string prompt = 3;
  string size = 4;
  string format = 5;
  repeated GeneratedImage images = 6;
  optional string error = 7;
}

message GeneratedImage {
  string filename = 1;
  string path = 2;
  string url = 3;
  int32 width = 4;
  int32 height = 5;
  string format = 6;
}

// File Creation Messages
message CreateUserFileRequest {
  string user_id = 1;
  string filename = 2;
  string content = 3;
  optional string folder_id = 4;
  optional string folder_path = 5;  // e.g., "Projects/Electronics" - will create if needed
  optional string title = 6;
  repeated string tags = 7;
  optional string category = 8;
}

message CreateUserFileResponse {
  bool success = 1;
  string document_id = 2;
  string filename = 3;
  string folder_id = 4;
  string message = 5;
  optional string error = 6;
}

message CreateUserFolderRequest {
  string user_id = 1;
  string folder_name = 2;
  optional string parent_folder_id = 3;
  optional string parent_folder_path = 4;  // e.g., "Projects" - will resolve to folder_id
}

message CreateUserFolderResponse {
  bool success = 1;
  string folder_id = 2;
  string folder_name = 3;
  optional string parent_folder_id = 4;
  string message = 5;
  optional string error = 6;
}

// Document Editing Messages
message UpdateDocumentMetadataRequest {
  string user_id = 1;
  string document_id = 2;
  optional string title = 3;
  optional string frontmatter_type = 4;  // e.g., "electronics", "fiction", "rules"
}

message UpdateDocumentMetadataResponse {
  bool success = 1;
  string document_id = 2;
  repeated string updated_fields = 3;  // e.g., ["title", "frontmatter_type"]
  string message = 4;
  optional string error = 5;
}

message UpdateDocumentContentRequest {
  string user_id = 1;
  string document_id = 2;
  string content = 3;  // New content (replace entire content) or content to append
  bool append = 4;  // If true, append to existing content; if false, replace entire content
}

message UpdateDocumentContentResponse {
  bool success = 1;
  string document_id = 2;
  int32 content_length = 3;  // Length of updated content
  string message = 4;
  optional string error = 5;
}

// Document Edit Proposal Messages (Universal Edit Proposal System)
message ProposeDocumentEditRequest {
  string user_id = 1;
  string document_id = 2;
  string edit_type = 3;  // "operations" or "content"
  
  // For operation-based edits
  repeated EditorOperationProto operations = 4;
  
  // For content-based edits
  optional ContentEditProto content_edit = 5;
  
  // Metadata
  string agent_name = 6;
  string summary = 7;
  bool requires_preview = 8;  // If false and edit is small, frontend may auto-apply
}

message ProposeDocumentEditResponse {
  bool success = 1;
  string proposal_id = 2;  // Unique ID for this proposal
  string document_id = 3;
  string message = 4;
  optional string error = 5;
}

message EditorOperationProto {
  string op_type = 1;  // "replace_range", "insert_after_heading", "delete_range"
  int32 start = 2;
  int32 end = 3;
  string text = 4;
  string pre_hash = 5;
  optional string original_text = 6;
  optional string anchor_text = 7;
  optional string left_context = 8;
  optional string right_context = 9;
  optional int32 occurrence_index = 10;
  optional string note = 11;
  optional float confidence = 12;
}

message ContentEditProto {
  string edit_mode = 1;  // "append", "replace", "insert_at"
  string content = 2;
  optional int32 insert_position = 3;
  optional string note = 4;
}

message ApplyDocumentEditProposalRequest {
  string user_id = 1;
  string proposal_id = 2;
  repeated int32 selected_operation_indices = 3;  // For operations: which to apply (empty = all)
}

message ApplyDocumentEditProposalResponse {
  bool success = 1;
  string document_id = 2;
  int32 applied_count = 3;  // Number of operations/content edits applied
  string message = 4;
  optional string error = 5;
}

// Direct operation application (for authorized agents only)
message ApplyOperationsDirectlyRequest {
  string user_id = 1;
  string document_id = 2;
  repeated EditorOperationProto operations = 3;
  string agent_name = 4;  // For security check
}

message ApplyOperationsDirectlyResponse {
  bool success = 1;
  string document_id = 2;
  int32 applied_count = 3;  // Number of operations applied
  string message = 4;
  optional string error = 5;
}

